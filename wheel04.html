<!DOCTYPE html>
<html lang = 'en'>
    <head>
        <title>Experiment - Scene similarity</title>
        <style>                                   
                   
        </style>
        <script src='jspsych-6.2.0/jspsych.js'></script>
        <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>        
        <script src="https://cdn.jsdelivr.net/npm/bowser@2.5.3/es5.min.js"></script>        
        <script src="js_library/modernizr-custom.js"></script>  
        <script src="js_library/underscore-min.js"></script> 
        <script src="js_library/factorial_noRandom.js"></script>      
        <script src="jspsych-6.2.0/plugins/jspsych-fullscreen.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-instructions.js"></script>      
        <script src='jspsych-6.2.0/plugins/jspsych-html-likert.js'></script> 
        <script src="jspsych-6.2.0/plugins/jspsych-external-html.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-button-response.js"></script>
        <script src="jspsych-6.2.0/plugins/jspsych-html-keyboard-response.js"></script>
        <link href='jspsych-6.2.0/css/jspsych.css' rel='stylesheet' type="text/css">
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/8.2.7/firebase-database.js"></script>       
    </head>
    <body></body>

    <script type="text/javascript">
        // Firebase set up
        var firebaseConfig = {
            apiKey: "AIzaSyCCfqbctlvGARj_IPbIOVAXlI5nv7gE-78",
            authDomain: "scenewheel-simjudge.firebaseapp.com",
            projectId: "scenewheel-simjudge",
            storageBucket: "scenewheel-simjudge.appspot.com",
            messagingSenderId: "657235385952",
            appId: "1:657235385952:web:0d6e1eb7021d80d58f2d05"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    
        // login anonymous user
        firebase.auth().signInAnonymously().catch(function(error) {
            var errorCode = error.code;
            var errorMessage = error.message;
        });
        
  
    </script>

    <script>
        
        // * browser info * //        
        var browser = bowser.getParser(window.navigator.userAgent);
        var browser_info = browser.getBrowser();
               
        // * image host * //
        var img_host = 'https://macklab.dev/resources/sceneWheel/validation_5radii/';

        // * wheel info * //
        var wheel_pool = ['01','02','03','04','05'];
        var main_wheel = '04';
        var prac_wheel = _.sample(wheel_pool.filter(item => item !== main_wheel), 1);

        // * condition set up * //        
        // -- practice condition -- //        
        var p_factor = {
            radius: ['32'],            
            stim_list: [[0,  0], [0, 30], [0, 60], [0, 90], 
                        [0,120], [0,150], [0,180], [0,210],
                        [0,240], [0,270], [0,300], [0,330]]
        }
        var p_cond = factorial_noRandom(p_factor);        
        var left_item = _.shuffle(Array(Math.floor(p_cond.length/2)).fill(0).concat(Array(Math.ceil(p_cond.length/2)).fill(1)));
        for (var i=0; i<p_cond.length; i++){            
            p_cond[i].left_item_idx = left_item[i];            
            p_cond[i].stim_path_left = [
                img_host+'Wheel'+prac_wheel+'/wheel'+prac_wheel+'_r'+p_cond[i].radius+'/'+
                ("00000"+p_cond[i].stim_list[left_item[i]]).slice(-6)+'.webp'
            ];
            p_cond[i].stim_path_right = [
                img_host+'Wheel'+prac_wheel+'/wheel'+prac_wheel+'_r'+p_cond[i].radius+'/'+
                ("00000"+p_cond[i].stim_list[(left_item[i]+1)%2]).slice(-6)+'.webp'
            ];
        };
        // -- main condition -- //
        var pair = []; // prepare all possible pairs
        var img_num = _.range(0,360,30);
        var identical_pair = _.sample(img_num,2); // catch trials
        pair.push([identical_pair[0],identical_pair[0]]);
        pair.push([identical_pair[1],identical_pair[1]]);        
        for (var i = 0; i < img_num.length - 1; i++) {            
            for (var j = i + 1; j < img_num.length; j++) {
                pair.push([img_num[i], img_num[j]]);
            }
        };
        var e_factors = {
            radius: ['02', '04', '08', '16', '32'],                 
            stim_list: pair
        };
        var e_cond = factorial_noRandom(e_factors);        
        // select one to be preseted left
        var left_item = _.shuffle(Array(e_cond.length/2).fill(0).concat(Array(e_cond.length/2).fill(1)));
        // specify path
        for (var i=0; i<e_cond.length; i++){
            e_cond[i].left_item_idx = left_item[i];
            e_cond[i].stim_path_left = [
                img_host+'Wheel'+main_wheel+'/wheel'+main_wheel+'_r'+e_cond[i].radius+'/'+
                ("00000"+e_cond[i].stim_list[left_item[i]]).slice(-6)+'.webp'
            ];
            e_cond[i].stim_path_right = [
                img_host+'Wheel'+main_wheel+'/wheel'+main_wheel+'_r'+e_cond[i].radius+'/'+
                ("00000"+e_cond[i].stim_list[(left_item[i]+1)%2]).slice(-6)+'.webp'
            ];
        };
        // divide into 5 blocks
        var n_block = 5;
        var e_cond = _.chunk(_.shuffle(e_cond), e_cond.length/n_block);
        
        // * preload images *//        
        var stimuli = [];
        for (i=0; i <p_cond.length; i++){
            stimuli.push(
                p_cond[i].stim_path_left,
                p_cond[i].stim_path_right,
                );
        }
        for (b=0; b<n_block; b++){
            for (i=0; i <e_cond[b].length; i++){
                stimuli.push(
                    e_cond[b][i].stim_path_left,
                    e_cond[b][i].stim_path_right,
                );
            };
        };
        
        // ************** Display set up *************** //
        // * Consent * //
        // var consent_inst = {
        //     type: 'html-button-response',
        //     stimulus: html='<p style="color: black; font-size: 20px;">'
        //         +'We would like to get your consent before starting the experiment.</p>',
        //     choices: ['Consent page'], 
        //     data: {disp_type: 'consent-instruction'}
        // }
        // var check_consent = function(elem) {
        //     if (document.getElementById('radio_agree').checked) {                             
        //         return true;
        //     } else {
        //         alert("If you wish to participate, you must check the box next to the statement 'I agree.'");
        //         return false;
        //     }
        //     return false;
        // };
        // var consent_page = {
        //     type: 'external-html',
        //     url: "materials/online_consent.html",
        //     cont_btn: "start",
        //     check_fn: check_consent,
        //     data: {disp_type: 'online_consent_form'}
        // }        

        // * Instruction * //  
        var instruction1 = {
            type: 'html-button-response',
            stimulus: '<p style="color: black; font-size: 20px;">'+
                '<b>Welcome to the experiment!</b><br><br>'+
                'In this experiment, you will be asked to judge the similarity of scene image pairs.<br>'+
                'Carefully look at the images and rate how similar they look to each other.<br><br>'+
                'Click the Next button to start the practice block. There will be '+p_cond.length+' trials.</p>',               
            choices: ['Start Practice'],                  
            data: {disp_type: 'instrcution-practice'}
        };       
        var instruction2 = {
            type: 'html-button-response',
            stimulus: '<p style="color: black; font-size: 20px;">'+
                "Practice trials are done. Now let's move onto the main session.<br><br>"+
                'In the main session, you will perform the same task.<br>'+
                'There will be '+_.flatten(e_cond).length+' trials, and '+(n_block-1)+' breaks will be given.</p>',
            choices: ['Start Main'],                  
            data: {disp_type: 'instruction-parctice'}
        };
        var test_break = {
            type: 'html-button-response',
            stimulus: '<p style="color: black; font-size: 20px;">'+
                'Take a break, and press the button to start again.</p>',
            choices: ['Start'],                  
            data: {disp_type: 'instruction-break'}
        };

        // * Trial composition * //
        var scale = [
            "<b>0</b><br>Low similarity", 
            "<b>1</b>", 
            "<b>2</b>", 
            "<b>3</b>", 
            "<b>4</b>",
            "<b>5</b><br>High similarity"
        ];        
        var pair_judge ={
            type: 'html-likert',
            questions: [{
                name: 'thisPair',
                stimulus_L: jsPsych.timelineVariable('stim_path_left'),
                stimulus_R: jsPsych.timelineVariable('stim_path_right'),                
                labels: scale,                
                required: true
            }],
            randomize_question_order: true,
            scale_width: 500,
            data: {
                disp_type: 'likert_display',                
                radius: jsPsych.timelineVariable('radius'),
                pair: jsPsych.timelineVariable('stim_list'),                                   
            }
        }
        var judgment_prac = {
            timeline: [pair_judge],
            timeline_variables: p_cond,
            randomize_order: true
        }
        var judgment_main0 = {
            timeline: [pair_judge],
            timeline_variables: e_cond[0],
            randomize_order: true
        }
        var judgment_main1 = {
            timeline: [pair_judge],
            timeline_variables: e_cond[1],
            randomize_order: true
        }
        var judgment_main2 = {
            timeline: [pair_judge],
            timeline_variables: e_cond[2],
            randomize_order: true
        }
        var judgment_main3 = {
            timeline: [pair_judge],
            timeline_variables: e_cond[3],
            randomize_order: true
        }
        var judgment_main4 = {
            timeline: [pair_judge],
            timeline_variables: e_cond[4],
            randomize_order: true
        }

        // * demographic page  * //
        // var demographic_page = {
        //     type: 'html-button-response',
        //     stimulus: html='<p style="color: black; font-size: 20px;">'
        //         +'You are done! But do not close this page until instructed.</br></br>'
        //         +'Now we would like to collect your demographic information.</br>'
        //         +'Click the <b>Demographic questions</b> below to complete the questionnaires.</br>'
        //         +'After completing the questionnaires, please <b>come back</b> to this page and press <b>Done</b> at the bottom.</br></br>'
        //         +'<a href="https://redcap.utoronto.ca/surveys/index.php?s=DDT8ME9KFL&study_name=scene_wheel_difficulty_check" target="_blank">'
        //         +'Demographic questions </a></br></br></p>',
        //     choices: ['Done'], 
        //     data: {disp_type: 'demographic-link'}        
        // }
        
        // * Debriefing form * //       
        // var debrief_page = {
        //     type: 'external-html',
        //     url: "materials/debriefing_letter.html",
        //     cont_btn: "finish",            
        //     data: {disp_type: 'debriefing_page'}
        // }
        
              

        // * timeline fill up * //  
        timeline = [];
        timeline.push(instruction1);
        timeline.push(judgment_prac);
        timeline.push(instruction2);
        for (b=0; b<n_block-1; b++) {          
            timeline.push(eval('judgment_main'+(b)));
            timeline.push(test_break);
        }
        timeline.push(eval('judgment_main'+(n_block-1)));
        
        // * for non-webp browsers * //
        var webp = Modernizr.webp;       
        if(!webp){
            var webp_warning = {
                type: 'html-keyboard-response',
                stimulus: '<p style="color: black; font-size: 20px;">'
                    +'Your browser does not support the webp image format,<br> '
                    +'which means that you will not be able to complete the experiment.<br>'
                    +'Browsers that support the webp include '
                    +'Chrome, Firefox, IE, Edge, etc (not Safari).',
                choices: jsPsych.NO_KEYS,
                trial_duration: 10000,
                data: {disp_type: 'webp_warning'}
            }
            var timeline = [webp_warning];
            var preload_images = ['stimuli/Wheel01/wheel01_r02/000000.webp']; // randomly load            
        }
       
        jsPsych.init({
            // exclusions: { webp: true },             
            timeline: timeline,           
            preload_images: stimuli,  
            show_progress_bar: true,                      
            on_finish: function() {
                jsPsych.data.displayData(); 

                // get data values
                var data = {experiment:"sceneWheel_similarityJudgment",
                            repo:"sceneWheel_similarityJudgment",
                            wheel_info:[main_wheel, prac_wheel],
                            data:jsPsych.data.get().values(),
                            browser_info:browser_info,
                            interaction_data:jsPsych.data.getInteractionData().values(),
                            exp_condition:e_cond}

                // send data to savejs
                var xhr = new XMLHttpRequest();
                xhr.open('POST','https://macklab-savejs.netlify.app/api/savejs');
                xhr.setRequestHeader('Content-Type','application/json');
                xhr.onload = function(){
                  if(xhr.status==200){
                    var response=JSON.parse(xhr.responseText);
                    console.log(response.success);
                  }
                };
                xhr.send(JSON.stringify(data));  

                // send data to firebase                      
                var tmp = new Uint32Array(1);
                tmp = window.crypto.getRandomValues(tmp)
                var dbpath = firebase.auth().currentUser.uid+'/'+tmp;
                firebase.database().ref(dbpath).set({
                    data: [
                        browser_info,
                        e_cond,
                        jsPsych.data.get().values(), 
                        jsPsych.data.getInteractionData().values()
                        ],
                    study: 'sceneWheel_similarityJudgment',
                    date: Date()
                });
            }
        });      
       
    

   </script>

</html>
    

    

       

